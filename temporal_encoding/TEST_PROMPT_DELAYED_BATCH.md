# æ–°æ–¹æ¡ˆæµ‹è¯•æŒ‡å— - æœåŠ¡å™¨è¿è¡Œ

## ğŸ“‹ æ–¹æ¡ˆæ€»ç»“

**æ ¸å¿ƒçªç ´ï¼š** å€Ÿé‰´ Flash-VStreamï¼Œé‡‡ç”¨"æµå¼æ”¶é›† + å»¶è¿Ÿæ‰¹é‡ç¼–ç "ç­–ç•¥

**è§£å†³çš„é—®é¢˜ï¼š**
- âœ… Vision Encoder è·¨å¸§æ³¨æ„åŠ›ï¼šå®Œæ•´ï¼ˆä¸å†æ˜¯å±€éƒ¨ï¼‰
- âœ… KV Cache å®Œæ•´æ€§ï¼šå®Œæ•´ï¼ˆä¸å†ä¸¢å¤±å†å²ï¼‰
- âœ… æ˜¾å­˜æ§åˆ¶ï¼šæ™ºèƒ½å¸§ç®¡ç†ï¼ˆStar + Stream Memoryï¼‰
- âœ… æ¨ç†è´¨é‡ï¼šæ¥è¿‘åŸç”Ÿè§†é¢‘æ¨ç†

**å…³é”®æ”¹è¿›ï¼š**
- æ”¾å¼ƒäº†"å¢é‡ç¼–ç "çš„æ‰§å¿µ
- åœ¨æé—®æ—¶æ‰æ‰¹é‡ç¼–ç ï¼ˆä½¿ç”¨ video æ¨¡å¼ï¼‰
- åŒé‡è®°å¿†æœºåˆ¶è‡ªåŠ¨ç­›é€‰é‡è¦å¸§

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºç¡€åŠŸèƒ½æµ‹è¯•

```bash
cd /root/autodl-tmp/diploma/temporal_encoding

# æµ‹è¯•æµå¼æ·»åŠ  + å¤šæ¬¡æé—® + cacheå¤ç”¨
python test_delayed_batch_inference.py --mode basic
```

**é¢„æœŸè¾“å‡ºï¼š**
```
================================================================================
æµ‹è¯•ï¼šå»¶è¿Ÿæ‰¹é‡ç¼–ç æ–¹æ¡ˆ (Delayed Batch Inference)
================================================================================

ğŸ“¦ åŠ è½½æ¨¡å‹: /root/autodl-tmp/Qwen/Qwen2___5-VL-3B-Instruct
ğŸš€ åˆå§‹åŒ– DelayedBatchInferenceEngine
âœ… SmartFrameManager Initialized:
   ğŸ“Œ Star Memory: 20 frames
   ğŸŒŠ Stream Window: 20 frames
   ğŸ¯ Importance Threshold: 0.6

âœ… åŠ è½½ 50 å¸§

================================================================================
é˜¶æ®µ 1ï¼šæµå¼æ·»åŠ å¸§
================================================================================
  [10/50] Frame #10 added to Stream Memory + Star Memory (åœºæ™¯å˜åŒ–) | Star: 3, Stream: 10
  [20/50] Frame #20 added to Stream Memory | Star: 5, Stream: 20
  [30/50] Frame #30 added to Stream Memory | Star: 8, Stream: 20
  [40/50] Frame #40 added to Stream Memory + Star Memory (é«˜é‡è¦æ€§(0.72)) | Star: 12, Stream: 20
  [50/50] Frame #50 added to Stream Memory | Star: 15, Stream: 20

âœ… æ‰€æœ‰å¸§å·²æ·»åŠ 

ğŸ“Š å¸§ç®¡ç†ç»Ÿè®¡:
  total_frames_added: 50
  star_memory_size: 15
  stream_memory_size: 20
  unique_frames: 30
  compression_ratio: 1.67x

================================================================================
é˜¶æ®µ 2ï¼šæé—®æµ‹è¯•
================================================================================

ğŸ”„ [ç¼–ç  #1] æ‰¹é‡ç¼–ç  30 å¸§
   ğŸ“Š Star: 15, Stream: 20, é‡å : 5
   ğŸ“‰ å‹ç¼©æ¯”: 1.67x (ä» 50 å¸§å‹ç¼©åˆ° 30 å¸§)
   âœ… ç¼–ç å®Œæˆï¼
   â±ï¸  è€—æ—¶: 3.45s
   ğŸ¯ Visual Tokens: 1248
   ğŸ’¾ KV Cache Length: 1512

â“ é—®é¢˜ 1: è¯·æè¿°è§†é¢‘ä¸­çš„ä¸»è¦å†…å®¹ã€‚
ğŸ’¬ å›ç­”: [æ¨¡å‹ç”Ÿæˆçš„å›ç­”]
ğŸ“Š æŒ‡æ ‡:
  total_latency: 4.82s
  generation_latency: 1.37s
  encoding_latency: 3.45s
  frames_encoded: 30
  visual_tokens: 1248

â“ é—®é¢˜ 2: è§†é¢‘ä¸­æœ‰ä»€ä¹ˆäººç‰©æˆ–ç‰©ä½“ï¼Ÿ
ğŸ’¬ å›ç­”: [æ¨¡å‹ç”Ÿæˆçš„å›ç­”]
ğŸ“Š æŒ‡æ ‡:
  total_latency: 1.15s
  generation_latency: 1.15s
  (æ³¨æ„ï¼šæ—  encoding_latencyï¼Œå› ä¸ºå¤ç”¨äº†cache)

================================================================================
é˜¶æ®µ 3ï¼šCache å¤ç”¨æµ‹è¯•
================================================================================

ğŸ”„ ç¬¬ 1 æ¬¡æé—®ï¼ˆåº”è¯¥å¤ç”¨ cacheï¼‰
ğŸ’¬ å›ç­”: [æ¨¡å‹ç”Ÿæˆçš„å›ç­”]
â±ï¸  æ€»è€—æ—¶: 0.98s
ğŸ“Š ç¼–ç è€—æ—¶: N/A (cacheå¤ç”¨)

[...ç±»ä¼¼è¾“å‡º...]

================================================================================
é˜¶æ®µ 4ï¼šæ·»åŠ æ–°å¸§ + é‡æ–°ç¼–ç 
================================================================================

â• æ·»åŠ  10 ä¸ªæ–°å¸§...
âœ… æ–°å¸§å·²æ·»åŠ 

ğŸ”„ [ç¼–ç  #2] æ‰¹é‡ç¼–ç  35 å¸§
   [...]

â“ æ·»åŠ æ–°å¸§åæé—®:
ğŸ’¬ å›ç­”: [æ¨¡å‹ç”Ÿæˆçš„å›ç­”]
ğŸ“Š æŒ‡æ ‡:
  total_latency: 5.12s
  encoding_latency: 3.78s
  (é‡æ–°ç¼–ç ï¼Œå› ä¸ºæœ‰æ–°å¸§åŠ å…¥)
```

### 2. å¯¹æ¯”æµ‹è¯•ï¼ˆåŸç”Ÿ vs å»¶è¿Ÿç¼–ç ï¼‰

```bash
python test_delayed_batch_inference.py --mode compare
```

**é¢„æœŸè¾“å‡ºï¼š**
```
================================================================================
å¯¹æ¯”æµ‹è¯•ï¼šåŸç”Ÿæ¨ç† vs å»¶è¿Ÿæ‰¹é‡ç¼–ç 
================================================================================

ğŸ“¦ åŠ è½½æ¨¡å‹: [...]
âœ… åŠ è½½ 30 å¸§

================================================================================
æ–¹æ³• 1ï¼šåŸç”Ÿè§†é¢‘æ¨ç†
================================================================================
ğŸ’¬ åŸç”Ÿå›ç­”: [æ¨¡å‹å›ç­”A]
â±ï¸  è€—æ—¶: 4.23s

================================================================================
æ–¹æ³• 2ï¼šå»¶è¿Ÿæ‰¹é‡ç¼–ç 
================================================================================
ğŸ”„ [ç¼–ç  #1] æ‰¹é‡ç¼–ç  25 å¸§
   ğŸ“Š Star: 12, Stream: 20, é‡å : 7
   ğŸ“‰ å‹ç¼©æ¯”: 1.20x (ä» 30 å¸§å‹ç¼©åˆ° 25 å¸§)
   [...]

ğŸ’¬ å»¶è¿Ÿç¼–ç å›ç­”: [æ¨¡å‹å›ç­”B]
â±ï¸  è€—æ—¶: 4.45s
ğŸ“Š è¯¦ç»†æŒ‡æ ‡:
  encoding_latency: 3.12s
  generation_latency: 1.33s
  frames_encoded: 25
  visual_tokens: 1050

================================================================================
ç»“æœå¯¹æ¯”
================================================================================

åŸç”Ÿå›ç­”:
[å®Œæ•´å›ç­”A]

å»¶è¿Ÿç¼–ç å›ç­”:
[å®Œæ•´å›ç­”B]

ğŸ“ é•¿åº¦æ¯”: 0.95
(è¯´æ˜ï¼šå›ç­”é•¿åº¦æ¥è¿‘ï¼Œè´¨é‡åº”è¯¥ç›¸ä¼¼)
```

---

## ğŸ“Š å…³é”®éªŒè¯ç‚¹

### âœ… æˆåŠŸæ ‡å¿—

1. **å¸§ç®¡ç†æœ‰æ•ˆ**
   - Star Memory å’Œ Stream Memory éƒ½æœ‰å¸§
   - å‹ç¼©æ¯” > 1.0ï¼ˆè¯´æ˜å»é‡ç”Ÿæ•ˆï¼‰
   - é‡è¦å¸§ï¼ˆåœºæ™¯å˜åŒ–ã€é«˜åˆ†æ•°ï¼‰è¢«æ­£ç¡®è¯†åˆ«

2. **ç¼–ç æˆåŠŸ**
   - `ç¼–ç å®Œæˆï¼` æç¤ºå‡ºç°
   - Visual Tokens > 0
   - KV Cache Length > 0
   - video_grid_thw æ˜¾ç¤ºæ­£ç¡®

3. **Cache å¤ç”¨**
   - ç¬¬äºŒæ¬¡æé—®æ—  `encoding_latency`
   - æ€»å»¶è¿Ÿæ˜¾è‘—é™ä½ï¼ˆä» 4-5s é™åˆ° 1-2sï¼‰

4. **è´¨é‡æ¥è¿‘åŸç”Ÿ**
   - å›ç­”é•¿åº¦æ¯”æ¥è¿‘ 1.0
   - å›ç­”å†…å®¹ç›¸ä¼¼ï¼ˆéœ€äººå·¥åˆ¤æ–­ï¼‰

### âŒ å¤±è´¥æ ‡å¿—

1. **ç¼–ç å¤±è´¥**
   - å‡ºç° `Error: no frames`
   - å‡ºç° `RuntimeError: CUDA out of memory`
   - Visual Tokens = 0

2. **Cache æœªå¤ç”¨**
   - æ¯æ¬¡æé—®éƒ½è§¦å‘ç¼–ç 
   - æ¯æ¬¡æé—®éƒ½æœ‰ `encoding_latency`

3. **è´¨é‡å·®**
   - å›ç­”é•¿åº¦æ¯” < 0.5 æˆ– > 2.0
   - å›ç­”å†…å®¹æ˜æ˜¾ä¸ç›¸å…³

---

## ğŸ”§ å‚æ•°è°ƒä¼˜

### æ˜¾å­˜ä¸è¶³æ—¶

**é”™è¯¯ä¿¡æ¯ï¼š**
```
RuntimeError: CUDA out of memory. Tried to allocate X MiB
```

**è§£å†³æ–¹æ¡ˆ 1ï¼šå‡å°å¸§æ•°**
```bash
# ä¿®æ”¹ test_delayed_batch_inference.py
frames = load_test_video_frames(video_dir, max_frames=20)  # ä» 50 é™åˆ° 20
```

**è§£å†³æ–¹æ¡ˆ 2ï¼šé™ä½åˆ†è¾¨ç‡**
```python
engine = DelayedBatchInferenceEngine(
    max_pixels=2 * 224 * 224,  # ä» 4Ã—224Â² é™åˆ° 2Ã—224Â²
)
```

**è§£å†³æ–¹æ¡ˆ 3ï¼šå‡å°è®°å¿†å®¹é‡**
```python
engine = DelayedBatchInferenceEngine(
    star_memory_size=10,      # ä» 20 é™åˆ° 10
    stream_window_size=10,    # ä» 20 é™åˆ° 10
)
```

### è´¨é‡ä¸è¶³æ—¶

**è§£å†³æ–¹æ¡ˆ 1ï¼šå¢åŠ å¸§æ•°**
```python
engine = DelayedBatchInferenceEngine(
    star_memory_size=30,      # å¢åŠ 
    stream_window_size=30,    # å¢åŠ 
)
```

**è§£å†³æ–¹æ¡ˆ 2ï¼šæé«˜åˆ†è¾¨ç‡**
```python
engine = DelayedBatchInferenceEngine(
    max_pixels=720 * 480,     # æé«˜
)
```

**è§£å†³æ–¹æ¡ˆ 3ï¼šé™ä½é‡è¦æ€§é˜ˆå€¼ï¼ˆä¿ç•™æ›´å¤šå¸§ï¼‰**
```python
from temporal_encoding.model.smart_frame_manager import SmartFrameManager

frame_manager = SmartFrameManager(
    importance_threshold=0.4,  # ä» 0.6 é™åˆ° 0.4
)
```

---

## ğŸ§ª è‡ªå®šä¹‰æµ‹è¯•

### æµ‹è¯•è‡ªå·±çš„è§†é¢‘

```python
import sys
sys.path.append("/root/autodl-tmp/diploma")

from temporal_encoding.model.delayed_batch_inference import DelayedBatchInferenceEngine
from transformers import Qwen2VLForConditionalGeneration, AutoProcessor
from PIL import Image
import torch

# 1. åŠ è½½æ¨¡å‹
model = Qwen2VLForConditionalGeneration.from_pretrained(
    "/root/autodl-tmp/Qwen/Qwen2___5-VL-3B-Instruct",
    torch_dtype=torch.bfloat16,
    device_map="cuda",
    trust_remote_code=True,
)
processor = AutoProcessor.from_pretrained(
    "/root/autodl-tmp/Qwen/Qwen2___5-VL-3B-Instruct",
    trust_remote_code=True,
)

# 2. åˆ›å»ºå¼•æ“
engine = DelayedBatchInferenceEngine(
    model=model,
    processor=processor,
    device="cuda",
)

# 3. åŠ è½½ä½ çš„è§†é¢‘å¸§
video_frames = [Image.open(f"/path/to/frame_{i}.jpg") for i in range(50)]

# 4. æ·»åŠ å¸§
for i, frame in enumerate(video_frames):
    status = engine.add_frame(frame, timestamp=i * 0.5)
    print(status)

# 5. æé—®
answer, metrics = engine.ask("è¯·æè¿°è§†é¢‘å†…å®¹ã€‚")
print(f"å›ç­”: {answer}")
print(f"æŒ‡æ ‡: {metrics}")
```

---

## ğŸ“ ä¸æ—§æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | Visionè·¨å¸§æ³¨æ„åŠ› | KV Cacheå®Œæ•´æ€§ | æ˜¾å­˜ | è´¨é‡ | çŠ¶æ€ |
|------|---------------|---------------|-----|-----|------|
| å¢é‡ç¼–ç  | âŒ æ—  | âœ… | âš ï¸ å¢é•¿ | å·® | å·²å¼ƒç”¨ |
| æ–¹æ¡ˆAï¼ˆæ›¿æ¢Cacheï¼‰ | âš ï¸ å±€éƒ¨ | âŒ ä¸¢å¤± | âœ… | å·® | **è‡´å‘½ç¼ºé™·** |
| **æ–°æ–¹æ¡ˆï¼ˆå»¶è¿Ÿç¼–ç ï¼‰** | âœ… å®Œæ•´ | âœ… å®Œæ•´ | âœ… | **å¥½** | **æ¨è** |

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### å¦‚æœæµ‹è¯•æˆåŠŸ

1. **è®ºæ–‡å®éªŒ**
   - åœ¨å¤šä¸ªè§†é¢‘æ•°æ®é›†ä¸Šæµ‹è¯•
   - å¯¹æ¯”åŸç”Ÿæ¨ç†çš„ç›¸ä¼¼åº¦
   - è®°å½•æ€§èƒ½æŒ‡æ ‡

2. **å‚æ•°æœç´¢**
   - æ‰¾åˆ°æœ€ä½³çš„ `star_memory_size` å’Œ `stream_window_size`
   - å¹³è¡¡è´¨é‡å’Œæ˜¾å­˜

3. **åº”ç”¨é›†æˆ**
   - é›†æˆåˆ° web demo
   - å®ç°å®æ—¶è§†é¢‘æµå¤„ç†

### å¦‚æœæµ‹è¯•å¤±è´¥

1. **æ£€æŸ¥é”™è¯¯æ—¥å¿—**
   - CUDA OOM â†’ å‡å°å¸§æ•°/åˆ†è¾¨ç‡
   - è´¨é‡å·® â†’ å¢åŠ å¸§æ•°/æé«˜åˆ†è¾¨ç‡
   - å…¶ä»–é”™è¯¯ â†’ æä¾›å®Œæ•´æ—¥å¿—

2. **å›é€€æ–¹æ¡ˆ**
   - å¦‚æœæ–°æ–¹æ¡ˆä»ä¸å¯è¡Œ
   - å»ºè®®å‘ Qwen å®˜æ–¹å¯»æ±‚æ”¯æŒ
   - æˆ–é‡‡ç”¨å®˜æ–¹æ¨èçš„æµå¼æ–¹æ¡ˆ

---

## ğŸ“® åé¦ˆ

æµ‹è¯•å®Œæˆåï¼Œè¯·æä¾›ï¼š

1. **æˆåŠŸ/å¤±è´¥çŠ¶æ€**
2. **å…³é”®æŒ‡æ ‡**
   - å‹ç¼©æ¯”
   - ç¼–ç æ—¶é—´
   - ç”Ÿæˆæ—¶é—´
   - å›ç­”è´¨é‡ï¼ˆäººå·¥åˆ¤æ–­ï¼‰
3. **å¯¹æ¯”æµ‹è¯•ç»“æœ**
   - åŸç”Ÿ vs å»¶è¿Ÿç¼–ç çš„å›ç­”
4. **é‡åˆ°çš„é—®é¢˜**ï¼ˆå¦‚æœ‰ï¼‰

---

**ç¥æµ‹è¯•é¡ºåˆ©ï¼è¿™ä¸ªæ–¹æ¡ˆåº”è¯¥èƒ½å¤Ÿè§£å†³ä¹‹å‰çš„å›°å¢ƒã€‚** ğŸš€
